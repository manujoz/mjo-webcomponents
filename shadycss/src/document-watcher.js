"use strict";import{nativeShadow}from"./style-settings.js";import StyleTransformer from"./style-transformer.js";import{getIsExtends,elementHasBuiltCss}from"./style-util.js";export let flush=function(){};function getClasses(element){if(element.classList&&element.classList.value){return element.classList.value}else{return element.getAttribute("class")||""}}const scopeRegExp=new RegExp(`${StyleTransformer.SCOPE_NAME}\\s*([^\\s]*)`);export function getCurrentScope(element){const match=getClasses(element).match(scopeRegExp);if(match){return match[1]}else{return""}}export function getOwnerScope(node){const ownerRoot=node.getRootNode();if(ownerRoot===node||ownerRoot===node.ownerDocument){return""}const host=ownerRoot.host;if(!host){return""}return getIsExtends(host).is}export function ensureCorrectScope(element){const currentScope=getCurrentScope(element),ownerRoot=element.getRootNode();if(ownerRoot===element){return}if(currentScope&&ownerRoot===element.ownerDocument){StyleTransformer.domRemoveScope(element,currentScope)}else if(ownerRoot instanceof ShadowRoot){const ownerScope=getOwnerScope(element);if(ownerScope!==currentScope){StyleTransformer.domReplaceScope(element,currentScope,ownerScope)}}}export function ensureCorrectSubtreeScoping(element){const unscopedNodes=window.ShadyDOM.nativeMethods.querySelectorAll.call(element,`:not(.${StyleTransformer.SCOPE_NAME})`);for(let j=0;j<unscopedNodes.length;j++){const unscopedNode=unscopedNodes[j],scopeForPreviouslyUnscopedNode=getOwnerScope(unscopedNode);if(scopeForPreviouslyUnscopedNode){StyleTransformer.element(unscopedNode,scopeForPreviouslyUnscopedNode)}}}function isElementWithBuiltCss(el){if("style"===el.localName||"template"===el.localName){return elementHasBuiltCss(el)}return!1}function handler(mxns){for(let x=0,mxn;x<mxns.length;x++){mxn=mxns[x];if(mxn.target===document.documentElement||mxn.target===document.head){continue}for(let i=0,n;i<mxn.addedNodes.length;i++){n=mxn.addedNodes[i];if(n.nodeType!==Node.ELEMENT_NODE){continue}n=n;let root=n.getRootNode(),currentScope=getCurrentScope(n);if(currentScope&&root===n.ownerDocument&&!isElementWithBuiltCss(n)){StyleTransformer.domRemoveScope(n,currentScope)}else if(root instanceof ShadowRoot){const newScope=getOwnerScope(n);if(newScope!==currentScope){StyleTransformer.domReplaceScope(n,currentScope,newScope)}ensureCorrectSubtreeScoping(n)}}}}if(!nativeShadow&&!(window.ShadyDOM&&window.ShadyDOM.handlesDynamicScoping)){let observer=new MutationObserver(handler),start=node=>{observer.observe(node,{childList:!0,subtree:!0})},nativeCustomElements=window.customElements&&!window.customElements.polyfillWrapFlushCallback;if(nativeCustomElements){start(document)}else{let delayedStart=()=>{start(document.body)};if(window.HTMLImports){window.HTMLImports.whenReady(delayedStart)}else{requestAnimationFrame(function(){if("loading"===document.readyState){let listener=function(){delayedStart();document.removeEventListener("readystatechange",listener)};document.addEventListener("readystatechange",listener)}else{delayedStart()}})}}flush=function(){handler(observer.takeRecords())}}